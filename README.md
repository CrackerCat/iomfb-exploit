# name

Write up is here: 

Exploit for CVE-2021-30807. This will require turning for your device.

For A11 and below, use pongo to load xnuspy and build with
`SAMPLING_SHMEM=1 make -B`. This will enable a test that creates 96 MB of
AGX shmem and figures out if that entire region is contiguous or not. If
it is, you'll see something like this:

```
sample_memory: for kernel mappings of 12 mbs:
sample_memory: 1: [0x1046e4000, 0x104ce4000)
sample_memory: 2: [0x104ce4000, 0x1052e4000)
sample_memory: 3: [0x1052e4000, 0x1058e4000)
sample_memory: 4: [0x1058e4000, 0x105ee4000)
sample_memory: 5: [0x105ee4000, 0x1064e4000)
sample_memory: 6: [0x1064e4000, 0x106ae4000)
sample_memory: 0xffffffe8c2524000
sample_memory: 0xffffffe8c2b24000 [0x600000 bytes from behind]
sample_memory: 0xffffffe8c3124000 [0x600000 bytes from behind]
sample_memory: 0xffffffe8c3724000 [0x600000 bytes from behind]
sample_memory: 0xffffffe8c3d24000 [0x600000 bytes from behind]
sample_memory: 0xffffffe8c4324000 [0x600000 bytes from behind]
sample_memory: contiguous! only keeping first & last allocs
sample_memory: to add to python3:
[0xffffffe8c2524000, 0xffffffe8c4f20000],
```

The last line is what you have to add to `alloc_list` inside
`alloc_averager.py`. Since this was a test for 12 MBs, I'd add it to the
list in the tuple that has `12` as its first element. Then I'd reboot my
phone and do it 15 - 20 more times.

Once you've done that 15 - 20 times, do `python3 alloc_averager.py` and
it will spit out a guess accompanied by a success rate. If the success rate
looks good to you, take the guess and replace `GUESSED_SHMEM_PTR` with it.

If `sample_memory` is reporting `NOT contiguous` for around half your boots,
then play around with the `mb` variable. `mb` is located right before
the three calls to `create_and_map_shmem`. The goal is to have a contiguous
range more than 80% of the time.

For example, this is what `alloc_averager.py` says for the contiguous
shmem ranges I gathered 30 seconds after a boot for my iPhone 8 running
iOS 14.6:

```
For 12 MB allocs: guess: 0xffffffe8c3898000 (100.00% chance (16/16) of being right)
```

For A12 and up, you'll just have to play around with `GUESSED_SHMEM_PTR`
and see what causes a panic and what doesn't.

For both A11 and below and A12 and above, if you guessed right, then
stage 1 is guaranteed to be successful.

Regarding stage 2, kalloc map bounds for all devices should be relatively
the same. You may have to play around with `start` and `end` inside
`exploit_stage2`. (or you could get Corellium on an A12+ and figure out
kalloc map bounds via kernel debugging)
