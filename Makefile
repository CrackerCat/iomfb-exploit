SDK = $(shell xcrun --sdk iphoneos --show-sdk-path)
CC = $(shell xcrun --sdk $(SDK) --find clang)
CFLAGS = -g -arch arm64 -isysroot $(SDK)
# make clang shut up about mach_port_destroy
CFLAGS += -Wno-deprecated-declarations
LDFLAGS = -framework CoreFoundation -framework IOKit

ifeq ($(SAMPLING_SHMEM), 1)
	CFLAGS += -DSAMPLING_SHMEM
endif

all : exploit

agx_shmem_hooks.o : agx_shmem_hooks.c agx_shmem_hooks.h
	$(CC) $(CFLAGS) agx_shmem_hooks.c -c

array.o : array.c array.h
	$(CC) $(CFLAGS) array.c -c

exploit : agx_shmem_hooks.o array.o iokit.h IOMobileFramebufferUserClient.c
	$(CC) $(CFLAGS) $(LDFLAGS) agx_shmem_hooks.o array.o IOMobileFramebufferUserClient.c -o exploit
	ldid -Sent.xml ./exploit
	sshpass -p "iphone" rsync -sz -e 'ssh -p 2222' ./exploit ./ent.xml \
		root@localhost:/var/root
